#include <SPI.h>
#include <Adafruit_GFX.h>
#include <Adafruit_PCD8544.h>

// Pin definitions for LEDs and ultrasonic sensors
const int led1 = 33;    // GPIO33
const int led2 = 32;    // GPIO32
const int led3 = 27;    // GPIO27
const int led4 = 26;    // GPIO26
const int ultraT1 = 25; // GPIO25 (Trigger 1)
const int ultraE1 = 23; // GPIO23 (Echo 1)
const int ultraT2 = 22; // GPIO22 (Trigger 2)
const int ultraE2 = 21; // GPIO21 (Echo 2)
const int ultraT3 = 19; // GPIO19 (Trigger 3)
const int ultraE3 = 18; // GPIO18 (Echo 3)
const int ultraT4 = 17; // GPIO17 (Trigger 4)
const int ultraE4 = 16; // GPIO16 (Echo 4)
const float distanciaLimite = 50.0;

// Nokia 5110 LCD pin configuration (Hardware SPI - VSPI)
const int lcd_dc = 15;   // GPIO15 (Data/Command select)
const int lcd_cs = 5;    // GPIO5 (Chip Select, VSPI CS0)
const int lcd_rst = 4;   // GPIO4 (Reset)
// SCLK and MOSI are handled by VSPI defaults: SCLK = GPIO18, MOSI = GPIO23
// Note: GPIO23 is shared with ultraE1, but we reassign ultraE1 to avoid conflict

// Initialize Nokia 5110 display with hardware SPI
Adafruit_PCD8544 display = Adafruit_PCD8544(lcd_dc, lcd_cs, lcd_rst);

void setup() {
  // Initialize pins
  pinMode(led1, OUTPUT);
  pinMode(led2, OUTPUT);
  pinMode(led3, OUTPUT);
  pinMode(led4, OUTPUT);
  pinMode(ultraT1, OUTPUT);
  pinMode(ultraE1, INPUT);
  pinMode(ultraT2, OUTPUT);
  pinMode(ultraE2, INPUT);
  pinMode(ultraT3, OUTPUT);
  pinMode(ultraE3, INPUT);
  pinMode(ultraT4, OUTPUT);
  pinMode(ultraE4, INPUT);

  // Initialize the Nokia 5110 display
  display.begin();
  display.setContrast(50); // Adjust contrast for best viewing (0-127)
  display.clearDisplay();
  display.display(); // Update display
  delay(2000);

  Serial.begin(115200); // ESP32 supports higher baud rates
}

float medirDistancia(int ultraT, int ultraE) {
  digitalWrite(ultraT, LOW);
  delayMicroseconds(2);
  digitalWrite(ultraT, HIGH);
  delayMicroseconds(10);
  digitalWrite(ultraT, LOW);
  
  long duracao = pulseIn(ultraE, HIGH);
  float distancia = duracao * 0.034 / 2;
  return distancia;
}

void loop() {
  float distancia1 = medirDistancia(ultraT1, ultraE1);
  float distancia2 = medirDistancia(ultraT2, ultraE2);
  float distancia3 = medirDistancia(ultraT3, ultraE3);
  float distancia4 = medirDistancia(ultraT4, ultraE4);
  
  int sensorAtivado = 0;
  int sensorDesativado = 0;

  if (distancia1 < distanciaLimite && distancia1 > 0) {
    digitalWrite(led1, HIGH);
    sensorAtivado++;
  } else {
    digitalWrite(led1, LOW);
    sensorDesativado++;
  }
  if (distancia2 < distanciaLimite && distancia2 > 0) {
    digitalWrite(led2, HIGH);
    sensorAtivado++;
  } else {
    digitalWrite(led2, LOW);
    sensorDesativado++;
  }
  if (distancia3 < distanciaLimite && distancia3 > 0) {
    digitalWrite(led3, HIGH);
    sensorAtivado++;
  } else {
    digitalWrite(led3, LOW);
    sensorDesativado++;
  }
  if (distancia4 < distanciaLimite && distancia4 > 0) {
    digitalWrite(led4, HIGH);
    sensorAtivado++;
  } else {
    digitalWrite(led4, LOW);
    sensorDesativado++;
  }

  // Clear the display buffer
  display.clearDisplay();
  
  // Set text size and position for Nokia 5110
  display.setTextSize(1); // Default size
  display.setTextColor(BLACK); // Set text color to black
  display.setCursor(0, 0); // Top-left corner
  display.print("Livres: ");
  display.print(sensorDesativado);
  display.setCursor(0, 16); // Move to next "line" (y=16 pixels down)
  display.print("Ocupadas: ");
  display.print(sensorAtivado);
  
  // Update the display
  display.display();
  delay(2000);
}
